<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>📚 فهرس دروس الشيخ بسام جرار</title>

<style>
body{font-family:"Segoe UI",Tahoma,Arial;line-height:1.8;background:#f8f8f8;margin:0;padding:24px}
h1{text-align:center;margin:0 0 24px}
#query{width:100%;max-width:650px;margin:auto;display:block;padding:12px;font-size:18px;border:1px solid #bbb;border-radius:8px}
.result{background:#fff;padding:12px;margin:12px 0;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.result b{display:block;margin-bottom:4px}
.result a{color:#0069c2;text-decoration:none}
.no-results{color:#c00;text-align:center;font-weight:bold;margin-top:24px}
.follow-up{margin-top:24px;text-align:center;font-style:italic}
</style>
</head>

<body>
<h1>📚 فهرس دروس الشيخ بسام جرار</h1>
<input id="query" placeholder="اكتب كلمة أو موضوعًا ثم Enter 🔍">

<div id="results"></div>

<script>
/*------------------------------------------------------------------------
  1) تحميل الداتا (lessons + concepts)
------------------------------------------------------------------------*/
let LESSONS=[], CONCEPTS={}, SURAH_SET=new Set();

Promise.all([
  fetch('lessons.json').then(r=>r.json()),
  fetch('concepts.json').then(r=>r.json())
]).then(([lessons,concepts])=>{
  LESSONS=lessons;
  CONCEPTS=concepts;
  lessons.forEach(r=>{
    r._normIndex=normalize(r.Index||"");      // نسخة مهيَّأة للتسريع
    SURAH_SET.add(normalize(r["Surah Name"]||""));
  });
}).catch(err=>{
  document.getElementById("results").innerHTML=
    `<div class="no-results">⚠️ خطأ فى تحميل الملفات: ${err}</div>`;
});

/*------------------------------------------------------------------------
  2) أدوات التطبيع والتحليل
------------------------------------------------------------------------*/
function normalize(str=""){
  return str.replace(/[\u064B-\u0652]/g,"")       // حركات
            .replace(/[أإآٱ]/g,"ا")               // همزات
            .replace(/ى/g,"ي")                    // ى ↔ ي
            .replace(/[^\u0621-\u064A0-9\s]/g,"") // رموز
            .replace(/\s+/g," ")
            .trim();
}

const prefixes=["ال","بال","كال","وال","فال","لل","س","و"];
const suffixes=["ه","ها","هم","كما","نا","كم","كن","ية","ان","ون","ات","ين","ا","ي"];
function lightStem(word){
  let w=word;
  prefixes.forEach(p=>{if(w.startsWith(p)&&w.length>p.length+2)w=w.slice(p.length);});
  suffixes.forEach(s=>{if(w.endsWith(s)&&w.length>s.length+2)w=w.slice(0,-s.length);});
  return w;
}

/*------------------------------------------------------------------------
  3) جمع المصطلحات الموسَّعة
------------------------------------------------------------------------*/
function collectTerms(qRaw){
  const set=new Set();
  set.add(qRaw);
  (CONCEPTS[qRaw]||[]).forEach(v=>set.add(v));
  qRaw.split(" ").forEach(w=>set.add(lightStem(w)));
  return [...set].map(normalize);
}

/*------------------------------------------------------------------------
  4) تحليل البحث المركَّب (سورة + رقم)
------------------------------------------------------------------------*/
function parseCompound(q){
  const words=q.split(" ");
  const num=words.find(w=>/^\d+$/.test(w));
  if(!num)return null;
  const name=words.filter(w=>w!==num).join(" ");
  return {surah:normalize(name),verse:num};
}

/*------------------------------------------------------------------------
  5) البحث وترتيب النتائج
------------------------------------------------------------------------*/
const weight={exact:0,normalized:1,compound:2,semantic:3};

function search(qRaw){
  const qNorm=normalize(qRaw);
  const compound=parseCompound(qNorm);
  const termSet=collectTerms(qRaw);
  const hits=[];

  LESSONS.forEach(r=>{
    if((r.Index||"").includes(qRaw))
      hits.push({r,type:"exact"});
    else if(r._normIndex.includes(qNorm))
      hits.push({r,type:"normalized"});
    else if(compound &&
            normalize(r["Surah Name"]||"")===compound.surah &&
            String(r["Verse No"]).replace(/\.0$/,"")===compound.verse)
      hits.push({r,type:"compound"});
    else{
      for(const term of termSet){
        if(r._normIndex.includes(term)){
          hits.push({r,type:"semantic"});
          break;
        }
      }
    }
  });

  // إزالة التكرار
  const seen=new Set();
  const unique=hits.filter(h=>{
    const key=h.r["Lesson Name "]+"|"+h.r.Minute;
    if(seen.has(key))return false;
    seen.add(key);return true;
  });

  return unique.sort((a,b)=>weight[a.type]-weight[b.type]);
}

/*------------------------------------------------------------------------
  6) عرض النتائج
------------------------------------------------------------------------*/
function show(hits,q){
  const box=document.getElementById("results");
  box.innerHTML="";
  if(!hits.length){
    box.innerHTML='<div class="no-results">⚠️ عذرًا، لا توجد نتائج لموضوعك في قاعدة البيانات. بإمكانك إعادة الصياغة أو تجربة مصطلحات ذات صلة.</div>';
    return;
  }
  hits.forEach(({r})=>{
    box.innerHTML+=`
      <div class="result">
        <b>عنوان الدرس:</b> ${r["Lesson Name "]||""}
        <b>الموضوع:</b> ${r.Index||""}
        <b>الدقيقة:</b> ${r.Minute||""}
        <b><a href="${r["Link to Minute"]||"#"}" target="_blank">اضغط هنا للمشاهدة ▶️</a></b>
      </div>`;
  });

  // اقتراح سؤال تابع
  const words=q.split(" ");
  if(words.length===1&&hits.length){
    const alt=normalize(hits[0].r.Index||"").split(" ").find(w=>w!==normalize(q));
    if(alt){
      box.innerHTML+=`<div class="follow-up">🤔 هل تقصد: <strong>${alt}</strong>؟</div>`;
    }
  }
}

/*------------------------------------------------------------------------
  7) ربط الإدخال بزر Enter
------------------------------------------------------------------------*/
document.getElementById("query").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const q=e.target.value.trim();
    if(q)show(search(q),q);
  }
});
</script>
</body>
</html>
