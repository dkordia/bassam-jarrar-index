<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ“š ÙÙ‡Ø±Ø³ Ø¯Ø±ÙˆØ³ Ø§Ù„Ø´ÙŠØ® Ø¨Ø³Ø§Ù… Ø¬Ø±Ø§Ø±</title>

<style>
body{font-family:"Segoe UI",Tahoma,Arial;line-height:1.8;background:#f8f8f8;margin:0;padding:24px}
h1{text-align:center;margin:0 0 24px}
#query{width:100%;max-width:650px;margin:auto;display:block;padding:12px;font-size:18px;border:1px solid #bbb;border-radius:8px}
.result{background:#fff;padding:12px;margin:12px 0;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.result b{display:block;margin-bottom:4px}
.result a{color:#0069c2;text-decoration:none}
.no-results{color:#c00;text-align:center;font-weight:bold;margin-top:24px}
.follow-up{margin-top:24px;text-align:center;font-style:italic}
</style>
</head>

<body>
<h1>ğŸ“š ÙÙ‡Ø±Ø³ Ø¯Ø±ÙˆØ³ Ø§Ù„Ø´ÙŠØ® Ø¨Ø³Ø§Ù… Ø¬Ø±Ø§Ø±</h1>
<input id="query" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ø«Ù… Enter ğŸ”">

<div id="results"></div>

<script>
/*------------------------------------------------------------------------
  1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§ØªØ§ (lessons + concepts)
------------------------------------------------------------------------*/
let LESSONS=[], CONCEPTS={}, SURAH_SET=new Set();

Promise.all([
  fetch('lessons.json').then(r=>r.json()),
  fetch('concepts.json').then(r=>r.json())
]).then(([lessons,concepts])=>{
  LESSONS=lessons;
  CONCEPTS=concepts;
  lessons.forEach(r=>{
    r._normIndex=normalize(r.Index||"");      // Ù†Ø³Ø®Ø© Ù…Ù‡ÙŠÙ‘ÙØ£Ø© Ù„Ù„ØªØ³Ø±ÙŠØ¹
    SURAH_SET.add(normalize(r["Surah Name"]||""));
  });
}).catch(err=>{
  document.getElementById("results").innerHTML=
    `<div class="no-results">âš ï¸ Ø®Ø·Ø£ ÙÙ‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª: ${err}</div>`;
});

/*------------------------------------------------------------------------
  2) Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠØ¹ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
------------------------------------------------------------------------*/
function normalize(str=""){
  return str.replace(/[\u064B-\u0652]/g,"")       // Ø­Ø±ÙƒØ§Øª
            .replace(/[Ø£Ø¥Ø¢Ù±]/g,"Ø§")               // Ù‡Ù…Ø²Ø§Øª
            .replace(/Ù‰/g,"ÙŠ")                    // Ù‰ â†” ÙŠ
            .replace(/[^\u0621-\u064A0-9\s]/g,"") // Ø±Ù…ÙˆØ²
            .replace(/\s+/g," ")
            .trim();
}

const prefixes=["Ø§Ù„","Ø¨Ø§Ù„","ÙƒØ§Ù„","ÙˆØ§Ù„","ÙØ§Ù„","Ù„Ù„","Ø³","Ùˆ"];
const suffixes=["Ù‡","Ù‡Ø§","Ù‡Ù…","ÙƒÙ…Ø§","Ù†Ø§","ÙƒÙ…","ÙƒÙ†","ÙŠØ©","Ø§Ù†","ÙˆÙ†","Ø§Øª","ÙŠÙ†","Ø§","ÙŠ"];
function lightStem(word){
  let w=word;
  prefixes.forEach(p=>{if(w.startsWith(p)&&w.length>p.length+2)w=w.slice(p.length);});
  suffixes.forEach(s=>{if(w.endsWith(s)&&w.length>s.length+2)w=w.slice(0,-s.length);});
  return w;
}

/*------------------------------------------------------------------------
  3) Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ù…ÙˆØ³Ù‘ÙØ¹Ø©
------------------------------------------------------------------------*/
function collectTerms(qRaw){
  const set=new Set();
  set.add(qRaw);
  (CONCEPTS[qRaw]||[]).forEach(v=>set.add(v));
  qRaw.split(" ").forEach(w=>set.add(lightStem(w)));
  return [...set].map(normalize);
}

/*------------------------------------------------------------------------
  4) ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø±ÙƒÙ‘ÙØ¨ (Ø³ÙˆØ±Ø© + Ø±Ù‚Ù…)
------------------------------------------------------------------------*/
function parseCompound(q){
  const words=q.split(" ");
  const num=words.find(w=>/^\d+$/.test(w));
  if(!num)return null;
  const name=words.filter(w=>w!==num).join(" ");
  return {surah:normalize(name),verse:num};
}

/*------------------------------------------------------------------------
  5) Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
------------------------------------------------------------------------*/
const weight={exact:0,normalized:1,compound:2,semantic:3};

function search(qRaw){
  const qNorm=normalize(qRaw);
  const compound=parseCompound(qNorm);
  const termSet=collectTerms(qRaw);
  const hits=[];

  LESSONS.forEach(r=>{
    if((r.Index||"").includes(qRaw))
      hits.push({r,type:"exact"});
    else if(r._normIndex.includes(qNorm))
      hits.push({r,type:"normalized"});
    else if(compound &&
            normalize(r["Surah Name"]||"")===compound.surah &&
            String(r["Verse No"]).replace(/\.0$/,"")===compound.verse)
      hits.push({r,type:"compound"});
    else{
      for(const term of termSet){
        if(r._normIndex.includes(term)){
          hits.push({r,type:"semantic"});
          break;
        }
      }
    }
  });

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
  const seen=new Set();
  const unique=hits.filter(h=>{
    const key=h.r["Lesson Name "]+"|"+h.r.Minute;
    if(seen.has(key))return false;
    seen.add(key);return true;
  });

  return unique.sort((a,b)=>weight[a.type]-weight[b.type]);
}

/*------------------------------------------------------------------------
  6) Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
------------------------------------------------------------------------*/
function show(hits,q){
  const box=document.getElementById("results");
  box.innerHTML="";
  if(!hits.length){
    box.innerHTML='<div class="no-results">âš ï¸ Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù…ÙˆØ¶ÙˆØ¹Ùƒ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙŠØ§ØºØ© Ø£Ùˆ ØªØ¬Ø±Ø¨Ø© Ù…ØµØ·Ù„Ø­Ø§Øª Ø°Ø§Øª ØµÙ„Ø©.</div>';
    return;
  }
  hits.forEach(({r})=>{
    box.innerHTML+=`
      <div class="result">
        <b>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³:</b> ${r["Lesson Name "]||""}
        <b>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</b> ${r.Index||""}
        <b>Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©:</b> ${r.Minute||""}
        <b><a href="${r["Link to Minute"]||"#"}" target="_blank">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© â–¶ï¸</a></b>
      </div>`;
  });

  // Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¤Ø§Ù„ ØªØ§Ø¨Ø¹
  const words=q.split(" ");
  if(words.length===1&&hits.length){
    const alt=normalize(hits[0].r.Index||"").split(" ").find(w=>w!==normalize(q));
    if(alt){
      box.innerHTML+=`<div class="follow-up">ğŸ¤” Ù‡Ù„ ØªÙ‚ØµØ¯: <strong>${alt}</strong>ØŸ</div>`;
    }
  }
}

/*------------------------------------------------------------------------
  7) Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø²Ø± Enter
------------------------------------------------------------------------*/
document.getElementById("query").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const q=e.target.value.trim();
    if(q)show(search(q),q);
  }
});
</script>
</body>
</html>
